<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HighPal Admin - Training Data Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .admin-content {
            padding: 40px;
        }
        
        .auth-section {
            background: #f8fafc;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .form-section {
            background: #f8fafc;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .form-section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        input[type="text"], input[type="password"], input[type="file"], select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }
        
        .status-message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4f46e5;
        }
        
        .stat-label {
            color: #6b7280;
            margin-top: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        .file-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-drop-zone:hover {
            border-color: #4f46e5;
            background: #f3f4f6;
        }
        
        .file-drop-zone.dragover {
            border-color: #4f46e5;
            background: #ede9fe;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ HighPal Admin Panel</h1>
            <p>Training Data Management System</p>
        </div>
        
        <div class="admin-content">
            <!-- Authentication Section -->
            <div class="auth-section">
                <h2>üîê Admin Authentication</h2>
                <div class="form-group">
                    <label for="adminKey">Admin Key:</label>
                    <input type="password" id="adminKey" placeholder="Enter admin key" value="admin123">
                </div>
                <button class="btn" onclick="authenticate()">Authenticate</button>
                <button class="btn btn-info" onclick="testConnection()" style="margin-left: 10px;">Test Connection</button>
            </div>
            
            <!-- Main Admin Panel (Hidden until authenticated) -->
            <div id="adminPanel" class="hidden">
                <!-- Stats Section -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDocs">-</div>
                        <div class="stat-label">Total Training Documents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCategories">-</div>
                        <div class="stat-label">Categories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="elasticsearchStatus">-</div>
                        <div class="stat-label">Elasticsearch Status</div>
                    </div>
                </div>
                
                <!-- Upload PDF Training Data -->
                <div class="form-section">
                    <h2>üìÑ Upload Training PDF</h2>
                    <div id="pdfStatus"></div>
                    <form id="pdfForm">
                        <div class="form-group">
                            <label for="pdfFile">Select PDF File:</label>
                            <div class="file-drop-zone" onclick="document.getElementById('pdfFile').click()">
                                <p>üìÅ Click to select PDF file or drag & drop here</p>
                                <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pdfCategory">Category:</label>
                            <select id="pdfCategory">
                                <option value="product_info">Product Information</option>
                                <option value="technical_docs">Technical Documentation</option>
                                <option value="company_policies">Company Policies</option>
                                <option value="faq">FAQ</option>
                                <option value="user_guides">User Guides</option>
                                <option value="troubleshooting">Troubleshooting</option>
                                <option value="custom">Custom Category</option>
                            </select>
                        </div>
                        <div class="form-group" id="customCategoryGroup" style="display: none;">
                            <label for="customCategory">Custom Category Name:</label>
                            <input type="text" id="customCategory" placeholder="Enter custom category name">
                        </div>
                        <button type="button" class="btn" onclick="uploadTrainingPDF()">Upload Training PDF</button>
                    </form>
                </div>
                
                <!-- Add Training URL -->
                <div class="form-section">
                    <h2>üåê Add Training URL</h2>
                    <div id="urlStatus"></div>
                    <form id="urlForm">
                        <div class="form-group">
                            <label for="trainingUrl">Website URL:</label>
                            <input type="text" id="trainingUrl" placeholder="https://example.com/article">
                        </div>
                        <div class="form-group">
                            <label for="urlCategory">Category:</label>
                            <select id="urlCategory">
                                <option value="product_info">Product Information</option>
                                <option value="technical_docs">Technical Documentation</option>
                                <option value="company_policies">Company Policies</option>
                                <option value="faq">FAQ</option>
                                <option value="user_guides">User Guides</option>
                                <option value="troubleshooting">Troubleshooting</option>
                                <option value="custom">Custom Category</option>
                            </select>
                        </div>
                        <div class="form-group" id="urlCustomCategoryGroup" style="display: none;">
                            <label for="urlCustomCategory">Custom Category Name:</label>
                            <input type="text" id="urlCustomCategory" placeholder="Enter custom category name">
                        </div>
                        <button type="button" class="btn" onclick="addTrainingURL()">Add Training URL</button>
                    </form>
                </div>
                
                <!-- Management Actions -->
                <div class="form-section">
                    <h2>üîß Management Actions</h2>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="loadTrainingData()">üîÑ Refresh Stats</button>
                        <button class="btn btn-info" onclick="viewTrainingData()">üìä View Training Data</button>
                        <button class="btn btn-danger" onclick="clearTrainingData()">üóëÔ∏è Clear Training Data</button>
                    </div>
                </div>
                
                <!-- Training Data List -->
                <div class="form-section" id="trainingDataSection" style="display: none;">
                    <h2>üìã Training Data List</h2>
                    <div id="trainingDataList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8001';
        let authenticated = false;
        let adminKey = '';

        // Category change handlers
        document.getElementById('pdfCategory').addEventListener('change', function() {
            const customGroup = document.getElementById('customCategoryGroup');
            customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        document.getElementById('urlCategory').addEventListener('change', function() {
            const customGroup = document.getElementById('urlCustomCategoryGroup');
            customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // File upload handlers
        const fileInput = document.getElementById('pdfFile');
        const dropZone = document.querySelector('.file-drop-zone');

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                dropZone.innerHTML = `<p>üìÑ Selected: ${this.files[0].name}</p>`;
            }
        });

        // Drag and drop
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', function() {
            this.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                fileInput.files = files;
                this.innerHTML = `<p>üìÑ Selected: ${files[0].name}</p>`;
            }
        });

        function authenticate() {
            adminKey = document.getElementById('adminKey').value;
            if (adminKey) {
                authenticated = true;
                document.getElementById('adminPanel').classList.remove('hidden');
                showStatus('success', 'Authenticated successfully!', 'pdfStatus');
                loadTrainingData();
            } else {
                showStatus('error', 'Please enter admin key', 'pdfStatus');
            }
        }

        async function testConnection() {
            try {
                showStatus('info', 'Testing backend connection...', 'pdfStatus');
                console.log('Testing connection to:', API_BASE);
                
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Health check result:', result);
                    showStatus('success', `‚úÖ Backend connected! Status: ${JSON.stringify(result)}`, 'pdfStatus');
                } else {
                    showStatus('error', `‚ùå Backend responded with status: ${response.status}`, 'pdfStatus');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                showStatus('error', `‚ùå Connection failed: ${error.message}. Check if backend is running on port 8000.`, 'pdfStatus');
            }
        }

        function showStatus(type, message, elementId) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        async function uploadTrainingPDF() {
            if (!authenticated) {
                showStatus('error', 'Please authenticate first', 'pdfStatus');
                return;
            }

            const fileInput = document.getElementById('pdfFile');
            const categorySelect = document.getElementById('pdfCategory');
            const customCategory = document.getElementById('customCategory');

            if (!fileInput.files.length) {
                showStatus('error', 'Please select a PDF file', 'pdfStatus');
                return;
            }

            const category = categorySelect.value === 'custom' ? customCategory.value : categorySelect.value;
            if (!category) {
                showStatus('error', 'Please specify a category', 'pdfStatus');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('category', category);
            formData.append('admin_key', adminKey);

            try {
                showStatus('info', 'Uploading and processing PDF...', 'pdfStatus');
                const response = await fetch(`${API_BASE}/admin/upload_training_pdf/`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    showStatus('success', `‚úÖ PDF uploaded successfully! Category: ${result.category}, Characters: ${result.character_count}`, 'pdfStatus');
                    document.getElementById('pdfForm').reset();
                    document.querySelector('.file-drop-zone').innerHTML = '<p>üìÅ Click to select PDF file or drag & drop here</p>';
                    loadTrainingData();
                } else {
                    showStatus('error', `‚ùå Error: ${result.detail}`, 'pdfStatus');
                }
            } catch (error) {
                showStatus('error', `‚ùå Network error: ${error.message}`, 'pdfStatus');
            }
        }

        async function addTrainingURL() {
            if (!authenticated) {
                showStatus('error', 'Please authenticate first', 'urlStatus');
                return;
            }

            const urlInput = document.getElementById('trainingUrl');
            const categorySelect = document.getElementById('urlCategory');
            const customCategory = document.getElementById('urlCustomCategory');

            if (!urlInput.value) {
                showStatus('error', 'Please enter a URL', 'urlStatus');
                return;
            }

            const category = categorySelect.value === 'custom' ? customCategory.value : categorySelect.value;
            if (!category) {
                showStatus('error', 'Please specify a category', 'urlStatus');
                return;
            }

            const formData = new FormData();
            formData.append('url', urlInput.value);
            formData.append('category', category);
            formData.append('admin_key', adminKey);

            try {
                showStatus('info', 'Fetching and processing URL...', 'urlStatus');
                const response = await fetch(`${API_BASE}/admin/add_training_url/`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    showStatus('success', `‚úÖ URL processed successfully! Category: ${result.category}, Characters: ${result.character_count}`, 'urlStatus');
                    document.getElementById('urlForm').reset();
                    loadTrainingData();
                } else {
                    showStatus('error', `‚ùå Error: ${result.detail}`, 'urlStatus');
                }
            } catch (error) {
                showStatus('error', `‚ùå Network error: ${error.message}`, 'urlStatus');
            }
        }

        async function loadTrainingData() {
            if (!authenticated) return;

            try {
                // First test basic connectivity
                console.log('Testing API connectivity...');
                const healthResponse = await fetch(`${API_BASE}/health`);
                
                if (!healthResponse.ok) {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }
                
                const healthResult = await healthResponse.json();
                console.log('Health check result:', healthResult);
                document.getElementById('elasticsearchStatus').textContent = 
                    healthResult.elasticsearch === 'connected' ? '‚úÖ' : '‚ùå';
                
                // Then try to get training data
                console.log('Fetching training data...');
                const response = await fetch(`${API_BASE}/admin/training_data/?admin_key=${adminKey}`);
                
                if (!response.ok) {
                    throw new Error(`Training data request failed: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Training data result:', result);
                
                document.getElementById('totalDocs').textContent = result.total_training_docs || 0;
                document.getElementById('totalCategories').textContent = Object.keys(result.categories || {}).length;
                
                showStatus('success', 'Connected to backend successfully!', 'pdfStatus');
                
            } catch (error) {
                console.error('Error loading training data:', error);
                document.getElementById('totalDocs').textContent = 'Error';
                document.getElementById('totalCategories').textContent = 'Error';
                document.getElementById('elasticsearchStatus').textContent = '‚ùå';
                showStatus('error', `Backend connection error: ${error.message}`, 'pdfStatus');
            }
        }

        async function viewTrainingData() {
            if (!authenticated) return;

            try {
                const response = await fetch(`${API_BASE}/admin/training_data/?admin_key=${adminKey}`);
                const result = await response.json();
                
                if (response.ok) {
                    const section = document.getElementById('trainingDataSection');
                    const listDiv = document.getElementById('trainingDataList');
                    
                    let html = '<h3>Categories:</h3><ul>';
                    for (const [category, count] of Object.entries(result.categories)) {
                        html += `<li><strong>${category}:</strong> ${count} documents</li>`;
                    }
                    html += '</ul><h3>Documents:</h3><ul>';
                    
                    for (const doc of result.training_documents) {
                        html += `<li><strong>${doc.filename || doc.url}</strong> (${doc.category}) - ${doc.content_length} chars</li>`;
                    }
                    html += '</ul>';
                    
                    listDiv.innerHTML = html;
                    section.style.display = 'block';
                }
            } catch (error) {
                console.error('Error viewing training data:', error);
            }
        }

        async function clearTrainingData() {
            if (!authenticated) return;
            
            if (!confirm('Are you sure you want to clear ALL training data? This cannot be undone!')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/clear_training_data/?admin_key=${adminKey}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (response.ok) {
                    showStatus('success', '‚úÖ Training data cleared successfully!', 'pdfStatus');
                    loadTrainingData();
                    document.getElementById('trainingDataSection').style.display = 'none';
                } else {
                    showStatus('error', `‚ùå Error: ${result.detail}`, 'pdfStatus');
                }
            } catch (error) {
                showStatus('error', `‚ùå Network error: ${error.message}`, 'pdfStatus');
            }
        }
    </script>
</body>
</html>
